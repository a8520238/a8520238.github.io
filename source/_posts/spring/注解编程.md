---
title: 注解编程
date: 2021-2-28
cover:
top_img:
categories: spring
tags: 
mathjax: true
katex: true
---
# 注解编程

## 1 注解的作用

- 替换XML这种配置形势，简化配置
- 替换接口，实现调用双方的契约性
> 通过注解的方式，在功能的调用者和功能者之间达成约定，进而进行功能的调用。因为注解应用更为方便灵活，在开发中推荐注解。
![](http://note.youdao.com/yws/public/resource/1f4682a8c41f4bbfefa91f24f452c92e/xmlnote/5C0EE9486E0647AA8B31EA23242AA549/4280)

- 查看创建的所有工厂
![](http://note.youdao.com/yws/public/resource/1f4682a8c41f4bbfefa91f24f452c92e/xmlnote/D7A71D5A6E814C37AD68AA6D439CF222/4631)

## 2 基础注解

> 这些注解都是简化XML配置，并不能完全替代XML

1. 对象创建相关
- 搭建开发环境
    <context:component-scan base-package="com.baizhi">,作用：让Spring框架在设置包及其子包中扫描对应的注解，使其生效。
- 对象创建注解
    @Component 
    + 反射获得class值， id为首单词首字母小写。用于替换<bean id="
" class="">
    + 细节1（反射的指定工厂的id值），@Component("id")
    + 细节2 （**Spring配置文件覆盖注解配置内容**），<bean id="id", class="class">,要注意id值和class要相同。
- @Component的衍生注解
    + @Repository  作用的Dao
    + @Servicr     作用在Service
    + @Controller  作用在Controller
    >上述三个注解本质上就是@Component注解，作用就是<bean>标签。提供这些衍生注解的作用就是为了更加准确表明一个类型的作用。
- @Scope注解
    + 作用控制简单对象创建次数，singleton|prototype, 默认值singleton
- @Lazy注解
    + 延时创建单实例对象，Spring会在使用该对象时创建
2. 生命周期相关注解
- 初始化相关方法 @PostConstruct 声明是初始化方法，对应<bean init-method>
- 销毁方法 @PreDestory 对应<bean destroy-method>
> 上述注解并不是Spring提供的，是JSR（JavaEE规范）
3. 注入相关的注解
- 用户自定义类型注入@Autowired
    + 基于类型注入， 注入对象的类型，必须与目标成员变量类型相同或者是其子类或者是实现类。
    + 基于名字注入，增加@Qualifier("要注入的实际类名"（第一个字母小写）)
    + 可以将@Autowired直接凡在成员变量上，Spring直接通过反射注入，放在set方法上，调用的是set方法进行注入。
    + JavaEE规范中类似的注解
        JSR250 @Resource(name="userDAOImpl")基于名字进行注入，或者在变量名上直接用@Resource，如果名字没有配对，直接按照类型注入
- JDK类型的注入
    @Value注解
![](http://note.youdao.com/yws/public/resource/1f4682a8c41f4bbfefa91f24f452c92e/xmlnote/C87287BBABAF49CEB403FA7BACD1454D/4418)
![](http://note.youdao.com/yws/public/resource/1f4682a8c41f4bbfefa91f24f452c92e/xmlnote/7DC06AD3036540DD9C4822D1CE658ED3/4414)
![](http://note.youdao.com/yws/public/resource/1f4682a8c41f4bbfefa91f24f452c92e/xmlnote/A12331269C8B4859878E60DFDB24A748/4416)
![](http://note.youdao.com/yws/public/resource/1f4682a8c41f4bbfefa91f24f452c92e/xmlnote/3313ACF63D9E4AA2B27E8730FA647A82/4424)

@PropertySource 作用是替换Spring配置文件中的<context:property-placeholder location="">
    
+ @Value修饰的变量不能是静态的 
+ @Value+Properties这种方式，不能注入集合类型。需要使用YAML的注入形式。
4. 注解扫描注解
    > <context:component-scan base-package="com.baizhi">只能当前包及其子包
    
- 排除方式

        <context:component-scan base-package="com.baizhi">

        <context:exclude-filter type=""expression="">
        //type:
        1 assignable:排除特定的类型 不进行扫描，在expression中设置该类
        2 annotation:排除特定的注解不进行扫描
        3 aspectj: 比如com.bean..*.排除bean包及其子包
        4 regex:正则表达式
        5 custom:自定义派出策略在框架底层实现
        <\context:component-scan>
- 包含方式

        <context:component-scan base-package="com.baizhi" use-default-filters="false">
        //use-default-filters=false让Spring的默认扫描失效
        <context:include-filter type=""expression="">
        type与排除方式中的作用相同
        <\context:component-scan>

> 配置互通：注解配置和配置文件的配置是互通的

> 基础注解用于程序员开发的类型上，非程序员开发不能用基础注解解决。比如SqlSessionFactoryBean

## 3 Spring高级注解

1. 配置bean
    @Configuration,用于替换applicationContext.xml
- AnnotationConfigApplicationContext
![](http://note.youdao.com/yws/public/resource/1f4682a8c41f4bbfefa91f24f452c92e/xmlnote/499F38C1F9A84D479491C3E4A70205BE/4549)
![](http://note.youdao.com/yws/public/resource/1f4682a8c41f4bbfefa91f24f452c92e/xmlnote/86ADD58D6BDF478391F0D8AFBB7F505F/4554)
- 配置bean开发的细节分析
    + 基于注解开发不能使用log4j日志，需要集成logback
    + @Configuration的本质：也是@Component的衍生注解
2. @Bean注解
    1. 在配置bean中使用，等用于xml文件中的<bean>标签。
    对象创建包括简单对象和复杂对象


![](http://note.youdao.com/yws/public/resource/1f4682a8c41f4bbfefa91f24f452c92e/xmlnote/C9DC6A1B01684D419DF17609D6674CAE/4581)


- 注意事项 复杂对象创建时也可以使用factoryBean
- 自定义id值@Bean("id")
- 引入scope控制对象创建次数
    2. @Bean自定义类型注入

![](http://note.youdao.com/yws/public/resource/1f4682a8c41f4bbfefa91f24f452c92e/xmlnote/7785F65F78E84C30BBA2D86876211DC0/4609)

通过上述方法解决JDK耦合，避免直接在代码中set出现耦合

3. @ComponentScan注解
    - 等同于<context:component-scan base-package="">
    - 在AppConfig上方加上这个注解即可
    - 使用注解进行排除的方法如下图
![](http://note.youdao.com/yws/public/resource/1f4682a8c41f4bbfefa91f24f452c92e/xmlnote/D06F205B3D51430A8648B53676BF400B/4623)
    - 包含方式就是将excludeFilters换成includeFilters,并设置useDefaultFilters=false.

## 4 spring多种配置方式的应用场景

### 4.1 四种配置方式
1. @Component及其衍生@Autowired，应用在程序员自己开发的类型上，比如service,dao,controller
2. @Bean，框架提供的类型，别的程序员开发的类型。
    没有源码，比如
    ```
    @Bean
    public User user() {
        return new User();
    }
    ```
3. 基于xml标签
4. 基于@Import(User.class),较少使用，主要用于多配制bean的整合上。
### 4.2 配置优先级

- @Component及其衍生注解 < @Bean < 配置文件bean标签
- 优先级高的配置，可以覆盖优先级低的配置
- ImportRecource(**.xml)在AppConfig上使用可以引入两种配置的整合。

### 4.2 多配制Bean整合
- ApplicationContext ctx = new AnnotationConfigApplicationContext(包名)
- ApplicationContext ctx = new AnnotationConfigApplicationContext(AppConfig class名)并在该类中使用@Import()注解

![](http://note.youdao.com/yws/public/resource/1f4682a8c41f4bbfefa91f24f452c92e/xmlnote/162120F0EB744C8F8E0EBF62D293AAD3/4687)

> 三种方法对应的整合方法

> 整合@Component @ComponentScan

> 整合@Bean 上述两种方法

> 整合xml @ImportResource(".xml")

## 5 配置bean 的底层实现

配置bean底层实际上是通过Cglib的代理方式

PropertySourcePlaceholderConfigure这个类是读properties的类，从原码加上看

![](http://note.youdao.com/yws/public/resource/1f4682a8c41f4bbfefa91f24f452c92e/xmlnote/96FA3468065444BDA8FAA4CCC1F98E18/4717)

![](http://note.youdao.com/yws/public/resource/1f4682a8c41f4bbfefa91f24f452c92e/xmlnote/DB1E8247DBCB42C9AD106829937A9A6A/4722)