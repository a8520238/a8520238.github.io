---
title: nginx
date: 2021-2-28
cover:
top_img:
categories: javaEE
tags: 
mathjax: true
katex: true
---
# nginx基本原理介绍

## 1 代理与反向代理

1. 代理服务器是位于客户端和原始服务器的一台中间服务器，为了从原始服务器获取到内容，客户端想代理服务器发送一个请求并带上目标服务器（原始服务器），代理服务器在接收到请求后就会将请求转发原始服务器，并将从原始服务器上获取到的数据返回给客户端，代理服务器是代理的客户端，所以一般客户端是知道代理服务器的存在的，比如翻墙就用了代理服务器。
2. 反向代理服务器是位于原始服务器端的服务器，反向代理服务器接受来自互联网的请求，然后将这些请求发送给内网的服务器，并将从内网的服务器获取结果返回给互联网上的客户端，反向代理服务器是代理的服务端，所以客户端是不知道反向代理服务器的存在的，服务端是知道反向代理服务器的。

## 2 代理服务器的作用

1. 访问原来无法访问的资源
2. 用作缓存，加速访问速度
3. 对客户端访问授权，上网进行认证
4. 代理可以记录用户访问记录（上网行为管理），对外隐藏用户信息

## 3 反向代理服务器的作用

1. 保护内网安全
2. 负载均衡
3. 缓存，减少服务器的压力

## 4 nginx的作用

1. 反向代理，将多台服务器代理成一台服务器
2. 负载均衡，将多个请求均匀的分配到多台服务器上，减轻每台服务器的压力，提高服务的吞吐量。
3. 动静分离，nginx可以用作静态文件的缓存

## 5 nginx的工作过程

![](http://note.youdao.com/yws/public/resource/bca95011244292ba9b4a461a47885868/xmlnote/050D686114EF408F86AD0A422C266E6E/9150)

1. 在nginx启动后，会有一个master进程和多个worker进程，master进程主要用来管理worker进程，包括：
- 接受信号
- 将信号分发给worker进程
- 监听worker进程的工作状态
- 当worker进程退出时（非正常），启动新的worker进程。
> 基本的网络事件会交给worker进程处理。多个worker进程之间是对等的，他们同等竞争来自客户端的请求，各进程互相之间是独立的 。一个请求，只可能在一个worker进程中处理，一个worker进程，不可能处理其它进程的请求。 worker进程的个数是可以设置的，一般我们会设置与机器cpu核数一致，这里面的原因与nginx的进程模型以及事件处理模型是分不开的 。
2. 当master接受到重新加载的信后时，master会重新加载配置文件，然后启动新的进程，使用新的worker进程来接受请求，并告诉老的worker进程他们可以退休了，老的worker进程处理完手中的请求就会退出。
3. worker进程是如何处理用户的请求
- master会根据配置文件生成一个监听相应端口的socket，然后再faster出多个worker进程，这样每个worker就可以接受从socket过来的消息（其实这个时候应该是每一个worker都有一个socket，只是这些socket监听的地址是一样的）
- 当一个连接过来的时候，每一个worker都能接收到通知，但是只有一个worker能和这个连接建立关系，其他的worker都会连接失败，nginx提供一个共享锁accept_mutex，有了这个共享锁后，就会只有一个worker去接收这个连接。当一个worker进程在accept这个连接之后，就开始读取请求，解析请求，处理请求，产生数据后，再返回给客户端，最后才断开连接，这样一个完整的请求就是这样的了。

## 6 nginx的事件驱动机制

为nginx事件处理机制是异步非阻塞的。nginx将一个请求划分为多个阶段来异步处理模块，每个阶段只是处理请求的一部分，如果请求的这一部分发生阻塞，nginx不会等待，它会处理其他的请求的某一部分。

### 6.1 epoll

epoll库是Nginx服务器支持的高性能事件驱动库之一。它是公认的最好的事件驱动模型。和poll库及select库有很大的区别
1.  poll和select都是创建一个待处理事件列表，然后把这个列表发给内核，返回的时候，再去轮询检查这个列表。以判断这个事件是否发生。在描述符太多的情况下，就会明显效率低下了。
2.  epoll把事件描述符列表的管理交给内核复制。一旦有某个事件发生，内核将发生事件的事件描述符交给Nginx的进程，而不是将整个事件描述符列表交给进程，让进程去轮询具体是哪个描述符。epoll()避免了轮询整个事件描述符列表。所以显得更高效。
3.  epoll库的基本步骤：
- epoll库通过相关调用通知内核创建一个有N个描述符的事件列表。然后给这个事件列表设置自己关心的事件。并把它添加到内核中。在具体的代码中还可以实现对相关调用的事件描述符列表进行修改和删除。
- 一旦设置完成就一直等待内核通知事件发生了，某一事件发生后，内核就将发生事件的描述符给epoll库，epoll去处理事件。